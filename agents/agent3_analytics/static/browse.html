<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrzeglƒÖdarka Ankiet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
            margin-bottom: 20px;
        }
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .filter-group button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .filter-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
            .filter-group button.secondary {
                background: #e9ecef;
                color: #333;
                border: 1px solid #ddd;
            }
            .filter-group button.secondary:hover {
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-box h3 {
            font-size: 12px;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        .stat-box .number {
            font-size: 28px;
            font-weight: bold;
        }
        .surveys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .survey-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            border-left: 4px solid #667eea;
        }
        .survey-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border-left-color: #764ba2;
        }
        .survey-card h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .survey-card p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        .survey-card .score {
            display: inline-block;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }
        .survey-card .date {
            color: #999;
            font-size: 11px;
            margin-top: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        .close-btn:hover {
            color: #000;
        }
        .survey-data {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .showing-info {
            text-align: center;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä PrzeglƒÖdarka Ankiet Student√≥w</h1>
            <p>Przejrzyj i filtruj odpowiedzi z ankiety zadowolenia.</p>
            
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>Numer ankiety:</label>
                    <input type="text" id="surveyId" placeholder="gen_resp_001 lub 123">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="showSpecificSurvey()">üîé Poka≈º ankietƒô</button>
                </div>
                <div class="filter-group">
                    <label>Numer albumu:</label>
                    <input type="text" id="albumNumber" placeholder="np. 208629">
                </div>
                <div class="filter-group">
                    <label>Data od:</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>Data do:</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-group">
                    <label>Ocena od:</label>
                    <input type="number" id="scoreMin" min="0" max="5" step="0.01" placeholder="0">
                </div>
                <div class="filter-group">
                    <label>Ocena do:</label>
                    <input type="number" id="scoreMax" min="0" max="5" step="0.01" placeholder="5">
                </div>
                <div class="filter-group">
                    <label>Limit:</label>
                    <select id="limitSelect">
                        <option value="20">20 ostatnich</option>
                        <option value="50">50 ostatnich</option>
                        <option value="100">100 ostatnich</option>
                        <option value="">Wszystkie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="loadSurveys()">üîç Zastosuj filtry</button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="secondary" onclick="resetFilters()">‚ôªÔ∏è Resetuj filtry</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats" id="stats">
                <div class="stat-box">
                    <h3>Ca≈Çkowita liczba</h3>
                    <div class="number" id="totalCount">-</div>
                </div>
                <div class="stat-box">
                    <h3>Wy≈õwietlane</h3>
                    <div class="number" id="displayedCount">-</div>
                </div>
                <div class="stat-box">
                    <h3>≈örednia ocena</h3>
                    <div class="number" id="avgScore">-</div>
                </div>
                <div class="stat-box">
                    <h3>Min ocena</h3>
                    <div class="number" id="minScore">-</div>
                </div>
                <div class="stat-box">
                    <h3>Max ocena</h3>
                    <div class="number" id="maxScore">-</div>
                </div>
            </div>
        </div>

        <div class="showing-info" id="showingInfo"></div>
        <div class="surveys-grid" id="surveysList">
            <div class="loading">‚è≥ ≈Åadowanie ankiet...</div>
        </div>
    </div>

    <!-- Modal -->
    <div id="surveyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('surveyModal');
        const closeBtn = document.querySelector('.close-btn');
        const surveysList = document.getElementById('surveysList');

        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == modal) modal.style.display = 'none';
        };

        async function loadSurveys() {
            try {
                surveysList.innerHTML = '<div class="loading">‚è≥ ≈Åadowanie ankiet...</div>';
                
                // Get filter values
                const albumNumber = document.getElementById('albumNumber').value.trim();
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const scoreMin = document.getElementById('scoreMin').value;
                const scoreMax = document.getElementById('scoreMax').value;
                const limit = document.getElementById('limitSelect').value;
                
                // Build URL with parameters
                let url = '/surveys/list?';
                if (limit) url += `limit=${limit}&`;
                if (albumNumber) url += `album_number=${albumNumber}&`;
                if (dateFrom) url += `date_from=${dateFrom}T00:00:00Z&`;
                if (dateTo) url += `date_to=${dateTo}T23:59:59Z&`;
                if (scoreMin) url += `score_min=${scoreMin}&`;
                if (scoreMax) url += `score_max=${scoreMax}&`;
                
                console.log('Fetching:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Data received:', data);
                
                if (data.status === 'success') {
                    surveysList.innerHTML = '';
                    
                    if (data.surveys.length === 0) {
                        surveysList.innerHTML = '<div class="loading">Brak ankiet spe≈ÇniajƒÖcych kryteria</div>';
                        updateStats(0, 0, 0, 0, 0);
                        return;
                    }
                    
                    let totalScore = 0;
                    let minScore = 5;
                    let maxScore = 0;
                    let scores = [];
                    
                    // Calculate stats
                    for (const survey of data.surveys) {
                        const satisfaction = survey.satisfaction_score || 0;
                        totalScore += satisfaction;
                        minScore = Math.min(minScore, satisfaction);
                        maxScore = Math.max(maxScore, satisfaction);
                        scores.push(satisfaction);
                    }
                    
                    // Load detailed data for each survey
                    for (const survey of data.surveys) {
                        try {
                            console.log('Loading survey:', survey.id);
                            const surveyResponse = await fetch(`/surveys/view/${survey.id}`);
                            const surveyData = await surveyResponse.json();
                            console.log('Survey data:', surveyData);
                            
                            if (surveyData.status === 'success') {
                                const s = surveyData.data;
                                const satisfaction = s.satisfaction_score || 0;
                                
                                const card = document.createElement('a');
                                card.href = '#';
                                card.className = 'survey-card';
                                const displayId = survey.response_id || survey.id;
                                card.innerHTML = `
                                    <h3>${displayId}</h3>
                                    <p><strong>Cel:</strong> ${s.q1_goal || 'N/A'}</p>
                                    <p><strong>Czas:</strong> ${s.q2_duration || 'N/A'}</p>
                                    <p><strong>Album:</strong> ${s.album_number || 'N/A'}</p>
                                    <span class="score">‚≠ê ${satisfaction.toFixed(2)}/5.0</span>
                                    <div class="date">üìÖ ${s.timestamp?.split('T')[0] || 'N/A'}</div>
                                `;
                                card.onclick = (e) => {
                                    e.preventDefault();
                                    showSurvey(survey.id);
                                };
                                surveysList.appendChild(card);
                            }
                        } catch (err) {
                            console.error('Error loading survey:', err);
                        }
                    }
                    
                    // Update stats
                    const avgScore = data.surveys.length > 0 ? totalScore / data.surveys.length : 0;
                    updateStats(data.total_count, data.surveys.length, avgScore, minScore, maxScore);
                    
                    // Update showing info
                    let infoText = `Wy≈õwietlane: ${data.surveys.length} z ${data.total_count} ankiet`;
                    if (dateFrom || dateTo) {
                        infoText += ' (filtrowane)';
                    }
                    document.getElementById('showingInfo').textContent = infoText;
                } else {
                    console.error('Error status from API:', data);
                    surveysList.innerHTML = `<div class="error">B≈ÇƒÖd API: ${data.error || 'Nieznany b≈ÇƒÖd'}</div>`;
                }
            } catch (error) {
                console.error('Exception in loadSurveys:', error);
                surveysList.innerHTML = `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
            }
        }

        function resetFilters() {
            document.getElementById('surveyId').value = '';
            document.getElementById('albumNumber').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('scoreMin').value = '';
            document.getElementById('scoreMax').value = '';
            document.getElementById('limitSelect').value = '20';
            loadSurveys();
        }
        
        async function showSpecificSurvey() {
            const surveyId = document.getElementById('surveyId').value.trim();
            if (!surveyId) {
                alert('Wprowad≈∫ numer ankiety');
                return;
            }
            try {
                await showSurvey(surveyId);
            } catch (error) {
                alert(`B≈ÇƒÖd: ${error.message}`);
            }
        }

        function updateStats(total, displayed, avg, min, max) {
            document.getElementById('totalCount').textContent = total;
            document.getElementById('displayedCount').textContent = displayed;
            document.getElementById('avgScore').textContent = displayed > 0 ? avg.toFixed(2) : '0.00';
            document.getElementById('minScore').textContent = displayed > 0 ? min.toFixed(2) : '0.00';
            document.getElementById('maxScore').textContent = displayed > 0 ? max.toFixed(2) : '0.00';
        }

        async function showSurvey(surveyId) {
            try {
                const response = await fetch(`/surveys/view/${surveyId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const s = data.data;
                    const headerId = s.response_id || surveyId;
                    const htmlContent = `
                        <h2>üìã ${headerId}</h2>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin: 5px 0;"><strong>Data:</strong> ${s.timestamp?.split('T')[0] || 'N/A'} ${s.timestamp?.split('T')[1]?.substring(0,8) || ''}</p>
                            <p style="margin: 5px 0;"><strong>ID Studenta:</strong> ${s.student_id || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Email:</strong> ${s.student_email || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Numer albumu:</strong> ${s.album_number || 'N/A'}</p>
                            <p style="margin: 5px 0; font-size: 18px;"><strong>Ocena og√≥lna:</strong> ‚≠ê <span style="color: #667eea; font-size: 24px; font-weight: bold;">${(s.satisfaction_score || 0).toFixed(2)}</span>/5.0</p>
                        </div>
                        
                        <h3 style="color: #667eea; margin-top: 20px;">üìù Podstawowe informacje</h3>
                        <div style="background: white; padding: 15px; border-left: 4px solid #667eea; margin: 10px 0;">
                            <p><strong>1. G≈Ç√≥wny cel wizyty:</strong><br>${s.q1_goal || 'N/A'}</p>
                            <p><strong>2. Czas spƒôdzony na chacie:</strong><br>${s.q2_duration || 'N/A'}</p>
                        </div>
                        
                        <h3 style="color: #667eea; margin-top: 20px;">üìä Oceny (1-5)</h3>
                        <div style="background: white; padding: 15px; border-left: 4px solid #764ba2; margin: 10px 0;">
                            <p><strong>3. Zrozumienie odpowiedzi:</strong> <span style="color: #667eea; font-weight: bold;">${s.q3_understanding}/5</span></p>
                            <p><strong>4. Jasno≈õƒá odpowiedzi:</strong> <span style="color: #667eea; font-weight: bold;">${s.q4_clarity}/5</span></p>
                            <p><strong>5. Dok≈Çadno≈õƒá informacji:</strong> <span style="color: #667eea; font-weight: bold;">${s.q5_accuracy}/5</span></p>
                            <p><strong>6. Przydatno≈õƒá uzyskanych informacji:</strong> <span style="color: #667eea; font-weight: bold;">${s.q6_usefulness}/5</span></p>
                            <p><strong>7. Radzenie sobie z trudnymi pytaniami:</strong> <span style="color: #667eea; font-weight: bold;">${s.q7_advanced_questions}/5</span></p>
                            <p><strong>8. Og√≥lne do≈õwiadczenie:</strong> <span style="color: #667eea; font-weight: bold;">${s.q8_overall_experience}/5</span></p>
                            <p><strong>9. ≈Åatwo≈õƒá obs≈Çugi:</strong> <span style="color: #667eea; font-weight: bold;">${s.q9_ease_of_use}/5</span></p>
                            <p><strong>10. Czas odpowiedzi:</strong> <span style="color: #667eea; font-weight: bold;">${s.q10_response_time}/5</span></p>
                            <p><strong>11. Rozumienie pyta≈Ñ przez AI:</strong> <span style="color: #667eea; font-weight: bold;">${s.q11_ai_understanding}/5</span></p>
                        </div>
                        
                        <h3 style="color: #667eea; margin-top: 20px;">üí¨ Por√≥wnania i plany</h3>
                        <div style="background: white; padding: 15px; border-left: 4px solid #667eea; margin: 10px 0;">
                            <p><strong>12. Por√≥wnanie z rozmowƒÖ z wyk≈ÇadowcƒÖ:</strong><br>${s.q12_chat_vs_teacher || 'N/A'}</p>
                            <p><strong>13. Czy u≈ºyjesz ponownie?</strong><br>${s.q13_future_use || 'N/A'}</p>
                        </div>
                        
                        <h3 style="color: #667eea; margin-top: 20px;">‚úçÔ∏è Opinie i sugestie</h3>
                        <div style="background: white; padding: 15px; border-left: 4px solid #764ba2; margin: 10px 0;">
                            <p><strong>14. Pozytywne aspekty:</strong><br><em>${s.q14_positive || 'Brak odpowiedzi'}</em></p>
                            <p><strong>15. Sugestie ulepsze≈Ñ:</strong><br><em>${s.q15_improvements || 'Brak odpowiedzi'}</em></p>
                            <p><strong>16. Napotkane problemy:</strong><br><em>${s.q16_problems || 'Brak odpowiedzi'}</em></p>
                            <p><strong>17. Dodatkowe informacje:</strong><br><em>${s.q17_additional_info || 'Brak odpowiedzi'}</em></p>
                        </div>
                        
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 20px; text-align: center;">
                            <p style="margin: 0;"><strong>Zgoda na kontakt:</strong> ${s.q18_contact_allowed || 'N/A'}</p>
                        </div>
                    `;
                    document.getElementById('modalBody').innerHTML = htmlContent;
                    modal.style.display = 'block';
                } else {
                    document.getElementById('modalBody').innerHTML = 
                        `<div class="error">B≈ÇƒÖd: ${data.error}</div>`;
                    modal.style.display = 'block';
                }
            } catch (error) {
                document.getElementById('modalBody').innerHTML = 
                    `<div class="error">B≈ÇƒÖd: ${error.message}</div>`;
                modal.style.display = 'block';
            }
        }

        // Load surveys on page load (default: 20 ostatnich)
        window.onload = loadSurveys;
    </script>
</body>
</html>
